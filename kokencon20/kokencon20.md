# 部室の人数を調べたい

allotted-time
: 10m

theme
: lightning-simple

# 目次
* 完成品の概要
* 他の手法など
* それぞれの手法の利点/欠点
* どうしてCOCOAを選んだか
* 現在の手法の問題点
* 今後

# 完成品の概要
* 部室周辺のCOCOA利用者の人数を数える
* 人数変化があればDiscord/Slackに通知する
* 5分おきにたこやきさんの入退室管理アプリに人数を送信する

# 他の手法など
こんなの考えつきますよね。

* Bluetooth/BLE
* COCOA(BLEを用いますが、分けておきます)
* 画像処理
* アプリなどから手動で操作
* ドアの開閉を調べる
* 電気のオンオフを調べる


# Bluetooth/BLE
この方法が多いと思います。

利点

* 機材がほぼいらない(ラズパイとスマホだけ)
* ユーザー操作いらず
* 個人を特定できる(MACアドレスによる)

欠点

* MACアドレスを教えてもらう必要あり(後述)
  * あまり教えたくないですよね
  * 個人を特定できてしまう

# Bluetoothのしくみ!
1. 端末がここにいるよと広告(advertise)する
    1. 主にBluetoothの設定画面を開いたとき
1. 広告されている間はスキャンで発見可能
    1. MACアドレスや製品情報が含まれ、ユーザがスキャン結果から目的のデバイスを選択
1. 得たMACアドレスに対して本格的に通信を行なう。

# どうやって使う？
* 普段は広告なんてしてない
  * スキャンだけじゃ存在がわからん!
* MACアドレスがわかれば?
  * スキャンの段階を飛ばして直接通信できる!
* linuxではl2pingコマンドなどで実現できる
  * $ sudo l2ping 00:11:22:33:44:55
  * 応答があれば存在、なければそこにはないですね
* できた!けどMACアドレス必要なのかぁ...

# 常に広告してくれぇ〜〜
* 流行りのCOCOAとかいうやつあるやんけ
  * どうやらまともな接続なし(広告だけ)で通信してるらしいぞ
* COCOAは以下のものを「常時」広告
  * MACアドレスはランダム(一意だと特定されるし)
  * これはCOCOAだぞと示すUUID
  * 15分で変更されるID

# 入退室管理に使えるか？
* スキャンだけで数を数えられる(すばらしい)
* 誰かがいることはわかる(よい)
* でも誰がいるのかはわからない(よい)
* スキャンから一瞬消えることが多い(うーん)
  * IDを見てユーザー別に存在を確認しよう!

Bluetoothの欠点は解消できそう

# 入退室判定のなかみ
1. スキャンにかかったIDを入室待ちに追加
1. 入室待ちの状態で1分経過したら入室扱い
1. どの状態でも1分いなくなったら退室扱い

1. 入室してる人数を数える。
    1. ただし入室待ちに誰かいる<=>不安定なとき は数えるのを一旦やめておく

# 問題点
* 隣の部室の電波を拾う
  * 部室の前を通るぐらいのノイズは消せるが、これはむり
  * 部員のMACアドレスのリストがあれば部員だけに限定できるが...つらい
* 入退室を通知したくない人がいるかも
  * 暫定的には、部室に入るときにBluetoothを切っていただけると...
* スマホを1人で2台持っている人が2人になる

# 今後
* 他のサービスや電子錠などとの連携
* なぜかログが取れないので解決したい

# COCOAのすごさ
* デバイスID(変更なし)
* デバイスIDから日替わりIDを生成
* 日替わりIDから15分替わりIDを生成、配布
* 感染した人の日替わりIDをサーバに送信、15分替わりIDを生成して保存されてるか確認

日替わりIDがないと15分替わりIDの関連性はわからない(たぶん)、15分で同一人物かわからなくなる

